#musthave for test

#-------------CORS------------------
# apply to system gateway, 功能可用但存在隔离性问题，等待社区修复
# apiVersion: gateway.envoyproxy.io/v1alpha1
# kind: SecurityPolicy
# metadata:
#   name: cors-example
#   namespace: sealos-system
# spec:
#   targetRef:
#     group: gateway.networking.k8s.io
#     kind: Gateway
#     name: eg
#   cors:
#     allowOrigins:
#     # - "https://{{ .cloudDomain }}{{ if .cloudPort }}:{{ .cloudPort }}{{ end }}"
#     # - "https://*.{{ .cloudDomain }}{{ if .cloudPort }}:{{ .cloudPort }}{{ end }}"
#     - "http://*.foo.com"
#     allowMethods:
#     - PUT
#     - GET
#     - POST
#     - DELETE
#     - PATCH
#     - OPTIONS
#     maxAge: 600s
#     allowCredentials: true

# apply to custom gateway, 功能可用但存在隔离性问题，等待社区修复
# apiVersion: gateway.envoyproxy.io/v1alpha1
# kind: SecurityPolicy
# metadata:
#   name: cors-example
#   namespace: ns-vrpg
# spec:
#   targetRef:
#     group: gateway.networking.k8s.io
#     kind: Gateway
#     name: mfqjpuycbgjrtdww
#   cors:
#     allowOrigins:
#     # - "https://{{ .cloudDomain }}{{ if .cloudPort }}:{{ .cloudPort }}{{ end }}"
#     # - "https://*.{{ .cloudDomain }}{{ if .cloudPort }}:{{ .cloudPort }}{{ end }}"
#     - "http://*.foo.com"
#     allowMethods:
#     - PUT
#     - GET
#     - POST
#     - DELETE
#     - PATCH
#     - OPTIONS
#     maxAge: 600s
#     allowCredentials: true


# apply to 二级域名的route  功能可用，隔离性正常
# apiVersion: gateway.envoyproxy.io/v1alpha1
# kind: SecurityPolicy
# metadata:
#   name: cors-example
#   namespace: ns-oehe
# spec:
#   targetRef:
#     group: gateway.networking.k8s.io
#     kind: HTTPRoute
#     name: bdkzlmibsivuiqav
#   cors:
#     allowOrigins:
#     # - "https://{{ .cloudDomain }}{{ if .cloudPort }}:{{ .cloudPort }}{{ end }}"
#     # - "https://*.{{ .cloudDomain }}{{ if .cloudPort }}:{{ .cloudPort }}{{ end }}"
#     - "http://*.foo.com"
#     allowMethods:
#     - PUT
#     - GET
#     - POST
#     - DELETE
#     - PATCH
#     - OPTIONS
#     maxAge: 600s
#     allowCredentials: true

# apply to 自定义域名的route  功能可用，隔离性正常
# apiVersion: gateway.envoyproxy.io/v1alpha1
# kind: SecurityPolicy
# metadata:
#   name: cors-example
#   namespace: ns-vrpg
# spec:
#   targetRef:
#     group: gateway.networking.k8s.io
#     kind: HTTPRoute
#     name: mfqjpuycbgjrtdww
#   cors:
#     allowOrigins:
#     # - "https://{{ .cloudDomain }}{{ if .cloudPort }}:{{ .cloudPort }}{{ end }}"
#     # - "https://*.{{ .cloudDomain }}{{ if .cloudPort }}:{{ .cloudPort }}{{ end }}"
#     - "http://*.foo.com"
#     allowMethods:
#     - PUT
#     - GET
#     - POST
#     - DELETE
#     - PATCH
#     - OPTIONS
#     maxAge: 600s
#     allowCredentials: true



#----------------ratelimit-------------------------
# apply to gateway  功能正常，隔离性有问题
# apiVersion: gateway.envoyproxy.io/v1alpha1
# kind: BackendTrafficPolicy 
# metadata:
#   name: ratelimit-policy
#   namespace: sealos-system
# spec:
#   targetRef:
#     group: gateway.networking.k8s.io
#     kind: Gateway
#     name: eg
#     namespace: sealos-system
#   rateLimit:
#     type: Local
#     local:
#       rules:
#       - clientSelectors:
#         - sourceCIDR: 
#             value: 0.0.0.0/0
#             # type: Distinct    #D必须大写
#         limit:
#           requests: 5
#           unit: Hour
#       # - clientSelectors:
#       #   - sourceCIDR: 
#       #       value: 192.168.0.54/32
#       #       # type: Distinct    #D必须大写
#       #   limit:
#       #     requests: 99999
#       #     unit: Second


#apply to rooute  功能正常，隔离性正常
# apiVersion: gateway.envoyproxy.io/v1alpha1
# kind: BackendTrafficPolicy 
# metadata:
#   name: ratelimit-policy
#   namespace: ns-oehe
# spec:
#   targetRef:
#     group: gateway.networking.k8s.io
#     kind: HTTPRoute
#     name: bdkzlmibsivuiqav
#     namespace: ns-oehe
#   rateLimit:
#     type: Local
#     local:
#       rules:
#       # - clientSelectors:
#       #   - sourceCIDR: 
#       #       value: 0.0.0.0/0
#       #       # type: Distinct    #D必须大写
#       - limit:
#           requests: 3
#           unit: Hour

#-------------------------circuitbreaker-----------------------
# apply to gateway  功能不太正常
# apiVersion: gateway.envoyproxy.io/v1alpha1
# kind: BackendTrafficPolicy
# metadata:
#   name: circuitbreaker
#   namespace: sealos-system
# spec:
#   targetRef:
#     group: gateway.networking.k8s.io
#     kind: Gateway
#     name: eg
#     namespace: sealos-system
#   circuitBreaker:
#     maxPendingRequests: 0
#     maxParallelRequests: 10

# apply to httproute  功能不太正常，隔离性正常
# apiVersion: gateway.envoyproxy.io/v1alpha1
# kind: BackendTrafficPolicy
# metadata:
#   name: circuitbreaker
#   namespace: ns-oehe
# spec:
#   targetRef:
#     group: gateway.networking.k8s.io
#     kind: HTTPRoute
#     name: bdkzlmibsivuiqav
#     namespace: ns-oehe
#   circuitBreaker:
#     maxPendingRequests: 0
#     maxParallelRequests: 10



#---------------------------max_request_header---------------------------
# 可以生效但是存在隔离性问题，mergeGateway的情况下会影响所有route
# apiVersion: gateway.envoyproxy.io/v1alpha1
# kind: EnvoyPatchPolicy
# metadata:
#  name: custom-maxheader-patch-policy
#  namespace: sealos-system
# spec: 
#  targetRef:
#    group: gateway.networking.k8s.io
#    kind: GatewayClass
#    name: eg
#  type: JSONPatch
#  jsonPatches:
#    - type: "type.googleapis.com/envoy.config.listener.v3.Listener"
#      # The listener name is of the form <GatewayNamespace>/<GatewayName>/<GatewayListenerName>
#      name: "sealos-system/eg/http"
#      operation:
#        op: "add"
#        path: "/default_filter_chain/filters/0/typed_config/max_request_headers_kb"
#        value: 1

#------------------------------csp----------------------------
##csp 用户自行按需配置
# apiVersion: gateway.networking.k8s.io/v1
# kind: HTTPRoute
# metadata:
#  name: sealos-desktop
#  namespace: sealos
# spec:
#  parentRefs:
#    - group: gateway.networking.k8s.io
#      kind: Gateway
#      name: eg
#      sectionName: https
#      namespace: sealos-system
#    - group: gateway.networking.k8s.io
#      kind: Gateway
#      name: eg
#      sectionName: http
#      namespace: sealos-system
#  hostnames:
#    - "desktop.192.168.0.15.nip.io"
#  rules:
#    - backendRefs:
#        - group: ""
#          kind: Service
#          name: desktop-frontend
#          port: 3000
#          weight: 1
#      matches:
#        - path:
#            type: PathPrefix
#            value: /get
#      filters:
#        - type: ResponseHeaderModifier
#          responseHeaderModifier:
#            add:
#              - name: "X-Xss-Protection"
#                value: "1; mode=block"
#              - name: "Content-Security-Policy"
#                value: "test"
#            remove:
#              - "content-length"
#            set:
#              - name: "content-type"
#                value: "test"

# csp  同listener一样，也会有隔离性问题
# apiVersion: gateway.envoyproxy.io/v1alpha1
# kind: EnvoyPatchPolicy
# metadata:
#   name: custom-csp-patch-policy
#   namespace: sealos-system
# spec:
#   targetRef:
#     group: gateway.networking.k8s.io
#     kind: GatewayClass
#     name: eg
#     namespace: sealos-system
#   type: JSONPatch
#   jsonPatches:
#     - type: "type.googleapis.com/envoy.config.route.v3.RouteConfiguration"
#       name: sealos-system/eg/http    #route configuration的名字，通常对应其listener的名字
#       operation:
#         op: "add"
#         path: "/response_headers_to_add"
#         value:
#           - header:
#               key: "X-Xss-Protection"
#               value: "1; mode=block"
#           - header:
#               key: "Content-Security-Policy"
#               value: "test"

#----------------------------------x-real-ip--------------------------------------------
# x-real-ip  demo测试时需要手动增加X-ENVOY-EXTERNAL-ADDRESS这个头部
# apiVersion: gateway.envoyproxy.io/v1alpha1
# kind: EnvoyPatchPolicy
# metadata:
#   name: custom-x-real-ip-patch-policy
#   namespace: sealos-system
# spec:
#   targetRef:
#     group: gateway.networking.k8s.io
#     kind: GatewayClass
#     name: eg
#     namespace: sealos-system
#   type: JSONPatch
#   jsonPatches:
#     - type: "type.googleapis.com/envoy.config.route.v3.RouteConfiguration"
#       name: sealos-system/eg/http    #route configuration的名字，通常对应其listener的名字
#       operation:
#         op: "add"
#         path: "/response_headers_to_add"
#         value:
#           - header:
#               key: "x-real-ip"
#               value: "%REQ(X-ENVOY-EXTERNAL-ADDRESS)%"

#-----------------------------------compressor--------------------------------------------
## default compressor(L2) 有隔离性问题
# apiVersion: gateway.envoyproxy.io/v1alpha1
# kind: EnvoyPatchPolicy
# metadata:
#  name: custom-compressor-patch-policy
#  namespace: sealos-system
# spec:
#  targetRef:
#    group: gateway.networking.k8s.io
#    kind: GatewayClass
#    name: eg
#    namespace: sealos-system
#  type: JSONPatch
#  jsonPatches:
#    - type: "type.googleapis.com/envoy.config.listener.v3.Listener"
#      name: sealos-system/eg/http
#      operation:
#        op: "add"
#        path: "/default_filter_chain/filters/0/typed_config/http_filters/-"
#        value:
#          name: envoy.filters.http.compressor
#          typed_config:
#            "@type": type.googleapis.com/envoy.extensions.filters.http.compressor.v3.Compressor
#            compressor_library:
#              name: text_optimized
#              typed_config:
#                "@type": type.googleapis.com/envoy.extensions.compression.gzip.compressor.v3.Gzip
#                compression_level: DEFAULT_COMPRESSION
#                compression_strategy: DEFAULT_STRATEGY
#                memory_level: 3
#                window_bits: 10
#            request_direction_config:
#              common_config:
#                enabled:
#                  default_value: false
#                  runtime_key: request_compressor_enabled
#            response_direction_config:
#              common_config:
#                content_type:
#                  - text/html
#                  - application/json
#                  - application/javascript
#                  - application/x-javascript
#                  - application/xhtml+xml
#                  - image/svg+xml
#                  - text/css
#                  - text/javascript
#                  - text/plain
#                  - text/xml
#                  - application/octet-stream
#                  - font/ttf
#                  - font/otf
#                  - font/eot
#                min_content_length: 1024
#              disable_on_etag_header: false

